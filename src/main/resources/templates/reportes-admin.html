<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Reportes | Olcese</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body class="bg-light">

<nav class="navbar navbar-dark bg-dark mb-4">
  <div class="container"><a class="navbar-brand" href="/dashboard-admin">‚Üê Volver</a></div>
</nav>

<div class="container">
  <div class="row g-4 mb-3">
    <div class="col-md-3">
      <label class="form-label">Desde</label>
      <input type="date" id="desde" class="form-control">
    </div>
    <div class="col-md-3">
      <label class="form-label">Hasta</label>
      <input type="date" id="hasta" class="form-control">
    </div>
    <div class="col-md-3 d-flex align-items-end">
      <button id="btn-aplicar" class="btn btn-primary w-100">Aplicar</button>
    </div>
  </div>

  <div class="row g-4">
    <div class="col-md-4">
      <div class="card p-3">
        <h6 class="text-muted">Resumen</h6>
        <div id="resumen-box" class="fs-5">Cargando‚Ä¶</div>
      </div>
    </div>

    <div class="col-md-8">
      <div class="card p-3">
        <h6 class="text-muted">Ventas por d√≠a</h6>
        <canvas id="chartVentasDia" height="110"></canvas>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card p-3">
        <h6 class="text-muted">Top productos</h6>
        <canvas id="chartTopProductos" height="140"></canvas>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card p-3">
        <h6 class="text-muted">Ventas por sucursal</h6>
        <canvas id="chartSucursal" height="140"></canvas>
      </div>
    </div>
  </div>
</div>

<script>
const fmtMon = v => Number(v||0).toLocaleString('es-PE',{minimumFractionDigits:2, maximumFractionDigits:2});

document.addEventListener("DOMContentLoaded", async () => {
  const hoy = new Date();
  const d30 = new Date(hoy); d30.setDate(hoy.getDate()-30);
  document.getElementById('desde').value = d30.toISOString().slice(0,10);
  document.getElementById('hasta').value = hoy.toISOString().slice(0,10);

  let ventasDiaChart, topProdChart, sucChart;

  async function cargar() {
    const desde = document.getElementById('desde').value;
    const hasta = document.getElementById('hasta').value;
    const headers = {
      "Authorization": `Bearer ${localStorage.getItem("token")}`
    };
    const q = `?desde=${desde}&hasta=${hasta}`;

    try {
      // --- Fetch de los datos ---
      const [resumen, vd, top, suc] = await Promise.all([
        fetch(`/api/reportes/resumen${q}`, {headers}).then(r=>r.json()),
        fetch(`/api/reportes/ventas-por-dia${q}`, {headers}).then(r=>r.json()),
        fetch(`/api/reportes/top-productos${q}&limite=7`, {headers}).then(r=>r.json()),
        fetch(`/api/reportes/ventas-por-sucursal${q}`, {headers}).then(r=>r.json())
      ]);

      // ‚úÖ Resumen con manejo de null
      const total = Number(resumen.totalVentas ?? 0);
      const pedidos = Number(resumen.totalPedidos ?? 0); // ‚úÖ plural correcto
      const ticket = Number(resumen.ticketPromedio ?? 0);

      document.getElementById('resumen-box').textContent =
        `Ventas: S/ ${total.toFixed(2)} ¬∑ Pedidos: ${pedidos} ¬∑ Ticket: S/ ${ticket.toFixed(2)}`;

      // üìä Ventas por d√≠a
      const labelsDia = vd.map(x => x.fecha);
      const dataDia   = vd.map(x => x.total);
      ventasDiaChart?.destroy();
      ventasDiaChart = new Chart(document.getElementById('chartVentasDia'), {
        type: 'line',
        data: { labels: labelsDia, datasets: [{ label:'S/ ventas', data: dataDia }] },
        options: { responsive: true, plugins:{legend:{display:false}} }
      });

      // üì¶ Top productos
      const labelsTop = top.map(x => x.label);
      const dataTop   = top.map(x => x.valor);
      topProdChart?.destroy();
      topProdChart = new Chart(document.getElementById('chartTopProductos'), {
        type: 'bar',
        data: { labels: labelsTop, datasets: [{ label:'Unidades', data: dataTop }] },
        options: { responsive: true, plugins:{legend:{display:false}} }
      });

      // üè¨ Ventas por sucursal
      const labelsSuc = suc.map(x => x.label || 'Sin sucursal');
      const dataSuc   = suc.map(x => x.valor);
      sucChart?.destroy();
      sucChart = new Chart(document.getElementById('chartSucursal'), {
        type: 'bar',
        data: { labels: labelsSuc, datasets: [{ label:'S/ ventas', data: dataSuc }] },
        options: { responsive: true, plugins:{legend:{display:false}} }
      });

    } catch (e) {
      console.error("Error al cargar reportes:", e);
      document.getElementById('resumen-box').textContent = "No se pudo cargar el resumen";
    }
  }

  // evento bot√≥n aplicar
  document.getElementById('btn-aplicar').addEventListener('click', cargar);
  cargar();
});
</script>
</body>
</html>
